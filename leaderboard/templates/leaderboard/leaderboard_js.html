{% extends "base.html" %}
{% load i18n %}
{% load staticfiles %}

{% block title %}Leaderboard{% endblock %}
{% block javascript %}
<script type="text/javascript">
    $("document").ready(function() {
		chart_data = {% autoescape off %}{{ chart }}{% endautoescape %}
		var chart = new CanvasJS.Chart("breakDownGraph", chart_data);
		chart.render();
    });
    function getResults() {
        var hostname = top.location.host.toString();
        $.post("http://"+hostname+"/leaderboard/",
            {
                "selVVP":$("#id_vol_v_perc").val(),
                "selMonth":$("#id_month").val(),
                "selSVS":$("#id_svs").val(),
                "selSOS":$("#id_sos").val(),
                "just_emp": "false",
            },
            makeChange, 'json');
    }
    function getNewEmp(emp) {
        var hostname = top.location.host.toString();
        $("#comanyName").text(emp);
        $.post("http://"+hostname+"/leaderboard/",
            {
            "just_emp": "true",
            "focusEmployer": emp,
            },
            newEmp, 'json');
    }
    function makeChange(data, status) {
        $("#month-label").text($("#id_month option:selected").text());
        $("#vvp-label").text($("#id_vol_v_perc option:selected").text());
        $('#id_companies').empty();
        if (data.vol_v_perc === 'perc') {
    		vvpMsg = '% participation out of {0} employees';
        }
        else {
    		vvpMsg = ' check-ins out of {0} employees';
        }
        if ($("#id_svs").val() !== "name") {
            empOptFS = '{0} place is {1} with {2}{3}';
        }
        else {
    		empOptFS = '{1} with {4} employees';
        }
        for(var i=0; i<data.top_companies.length; i++) {
            $('#id_companies').append('<option value="{0}">{1}</option>'.format(data.top_companies[i][0], empOptFS.format(Number.getOrdinalFor(i+1, true), data.top_companies[i][0], data.top_companies[i][2], vvpMsg.format(data.top_companies[i][3]), data.top_companies[i][3])));
        }
        newEmp(data, status);
    }

    (function(o) {
     Number.getOrdinalFor = function(intNum, includeNumber) {
     return (includeNumber ? intNum : "")
     + (o[((intNum = Math.abs(intNum % 100)) - 20) % 10] || o[intNum] || "th");
     };
     })([,"st","nd","rd"]);

    function newEmp(data, status) {
    	if ($("#id_svs").val() == "name") {
    		$("#sector_label").parents("span").removeClass("hidden");
    		$("#sector_label").text(data.emp_sector);
    		if (typeof data.emp_size_cat !== 'undefined') {
    			$("#size_label").parents("span").removeClass("hidden");
    			$("#size_label").text(data.emp_size_cat);
    		}
    	}
    	else {
    		$(".sas_label").addClass("hidden");
    	}
        var chart = new CanvasJS.Chart("breakDownGraph", data.chart_data);
        chart.render();
        $("#total_checkins").text(data.total_breakdown.total);
        $("#total_gs").text(data.total_breakdown.gs);
        $("#total_gc").text(data.total_breakdown.gc);
        $("#total_us").text(data.total_breakdown.us);
        $("#total_cc").text(data.total_breakdown.cc);
        var commuterModes = ['c', 'cp', 'w', 'b', 't', 'tc', 'o'];
        tableString = "#breakDownTable>table>tbody>tr:eq({0})>td:eq({1})";
        for (var i=0; i<7; i++) { // td differentiation is normal day differentiation
            for (var j=0; j<7; j++) {
                $(tableString.format((i+1).toString(), (j+1).toString())).text(data.checkin_matrix[i][j]);
            }
        }
    }
    function switchSOS() {
        newSOS = $("#id_svs").val();
        if (newSOS == "size") {
            $("#sosdiv").removeClass("hidden");
            $("#vvpdiv").removeClass("hidden");
            $("#monthdiv").removeClass("hidden");
            $("#sos_label>strong").text("Select Size");
            $("#id_sos").empty();
    		if ($("#id_vol_v_perc").val() == 'vol') {
            	$("#id_sos").html('<option value="1">Small (1-10 Employees)</option><option value="2">Medium (11-100 Employees)</option><option value="3">Large (101-1000 Employees)</option><option value="4" selected="true">Largest (>1000 Employees)</option>');
    		}
    		else {
    			$("#id_sos").html('<option value="1">Small (1-10 Employees)</option><option value="2" selected="true">Medium (11-100 Employees)</option><option value="3">Large (101-1000 Employees)</option><option value="4">Largest (>1000 Employees)</option>');
    		}
        }
        else if (newSOS == "sector") {
            $("#sosdiv").removeClass("hidden");
            $("#vvpdiv").removeClass("hidden");
            $("#monthdiv").removeClass("hidden");
            $("#sos_label>strong").text("Select Sector");
            $("#id_sos").empty(); 
            $("#id_sos").html("{% for sector in sectors %}<option value={{ sector.id }}>{{ sector.name }}</option>{% endfor %}"); 
        }
        else {
            $("#sosdiv").addClass("hidden");
            $("#vvpdiv").addClass("hidden");
            $("#monthdiv").addClass("hidden");
        }
        getResults();
    }
    String.prototype.format = function() {
        var formatted = this;
        for(arg in arguments) {
            formatted = formatted.replace("{" + arg + "}", arguments[arg]);
        }
        return formatted;
    };

    //for rotated text header on the matrix
    $('.matrixWRlabel').css('height', $('.matrixWRlabel').width());

    //toggle the dropdown menu when selecting filters
    $('#sizeoption,#sectoroption,#groupsoption').hide();

    $('input[name="filter"]').change(function(){   
        //if size selected
        if($(this).val() == "size"){
            //display size dropdown
            $('#sizeoption').show();
            $('#sectoroption,#groupsoption').hide();
        }
        //if sector selected
        else if($(this).val() == "sector"){
            //display sector dropdown
            $('#sizeoption,#groupsoption').hide();
            $('#sectoroption').show();
        }

        //if groups with subteams selected
        else if($(this).val() == "groups"){
            //display groups dropdown
            $('#sizeoption,#sectoroption').hide();
            $('#groupsoption').show();
        }

        //if no filter selected
        else { $('#sizeoption,#sectoroption,#groupsoption').hide(); }
    });

	
</script>
<script type="text/javascript">
function setfilter(filter) {
		if(filter == "size") { 
			$('#size_filter').show();
			$('#size_filter').removeAttr('disabled');
			$('#team_filter').hide();
			$('#team_filter').attr('disabled', "true");
			$('#sector_filter').hide();
			$('#sector_filter').attr('disabled', "true");
		}
		else if(filter == "team") { 
			$('#team_filter').show();
			$('#team_filter').removeAttr('disabled');
			$('#size_filter').hide();
			$('#size_filter').attr('disabled', "true");
			$('#sector_filter').hide();
			$('#sector_filter').attr('disabled', "true");
		}
		else if(filter == "sector") { 
			$('#sector_filter').show();
			$('#sector_filter').removeAttr('disabled');
			$('#size_filter').hide();
			$('#size_filter').attr('disabled', "true");
			$('#team_filter').hide();
			$('#team_filter').attr('disabled', "true");
		}
	}
</script>
<script type="text/javascript" src="{% static 'libs/canvasjs.min.js' %}"></script>
{% endblock %}


{% block body %}
    <div class="row clearfix">
        <div class="col-md-12 column">
            <center><h1>Walk/Ride Day Leaderboard</h1>
        </div>
    </div>

    <div class="row clearfix filters lbcontrols">
	<form method="get" action="/leaderboard/redirect" id="filter_form">
        <div class="col-md-12 column">
            {% if current_month == 'all' %}<span class="lbmonth">{{ current_month }}</span>{% endif %}
            {% if current_month != 'all' %}
            <a href="/leaderboard/{% if empid %}{{ empid }}/{% endif %}{% if filter_by == 'size' and not sectorid %}{{ filter_by }}/{% endif %}{% if filter_by and sectorid %}{{ filter_by }}/{% endif %}{% if sectorid and filter_by == 'sector' %}{{ sectorid }}/{% endif %}{% if filt and filter_by == 'size' %}{{ filt }}/{% endif %}{% if sort %}{{ sort }}/{% endif %}month_all" class="lbmonth">all</a>
            {% endif %}
            {% for month in months %}           
            {% if month.url_month != current_month %}
            <a href="/leaderboard/{% if empid %}{{ empid }}/{% endif %}{% if filter_by == 'size' and not sectorid %}{{ filter_by }}/{% endif %}{% if filter_by and sectorid %}{{ filter_by }}/{% endif %}{% if sectorid and filter_by == 'sector' %}{{ sectorid }}/{% endif %}{% if filt and filter_by == 'size' %}{{ filt }}/{% endif %}{% if sort %}{{ sort }}/{% endif %}month_{{ month.url_month }}" class="lbmonth">{{ month }}</a>
            {% endif %} 
            
            {% if month.url_month == current_month %}
            <span class="lbmonth">{{ month }}</span>
            {% endif %} 

            {% endfor %}
        </div>
        <div class="col-md-6 column">
            <p class="lead"><strong>Filter the companies by</strong></p>
            <label><input type="radio" name="color" onclick="setfilter('size')" value="size"/> Size</label>
            <label><input checked="true" type="radio" name="color" onclick="setfilter('sector')" value="sector"/> Sector</label>
            <label><input type="radio" name="color" onclick="setfilter('team')" value ="sector"/> Groups with subteams</label>

            <!-- size options -->
            <select id="size_filter" name="size_filter" class="form-control" style="display: none" disabled="true">
            <option value="0" selected>Please select size</option>
            <option value="1">Small (1 - 50 Employees)</option>
            <option value="2">Medium (51 - 300 Employees)</option>
            <option value="3">Large (301 - 2000 Employees)</option>
            <option value="4">Largest (&gt; 2000 Employees)</option>
            </select>

            <!-- sector options -->
            <select class="form-control" id="sector_filter" name="sector_filter">
                <option value="0" selected>Please select sector</option>
                <!-- change slice number if number of sectors changes -->
            {% for sector in sectors|slice:":7" %}<option value="{{ sector.id }}">{{ sector.name }}</option>{% endfor %}
            </select>
            <select class="form-control" id="team_filter" style="display: none" name="sector_filter"  disabled="true">
                <option value="0" selected>Please select group</option>
            {% for team in subteams %}<option value="{{ team.id }}">{{ team.name }}</option>{% endfor %}
            </select>
        {% if sort %}<input type="hidden" name="sort" value="{{ sort }}">{% endif %}
		<input type="hidden" name="month" value="{{ current_month }}">
            <button type="submit" class="btn btn-small btn-success">Submit</button>
        </div>
<!--  disabled for performance reasons
        <div class="col-md-6 column">
            <p class="lead"><strong>Please choose ranking type</strong></p>
            <div class="btn-group">
            {% if not filt and not empid %}
            <a href="/leaderboard/participation" class="btn btn-default participation {% if sort == 'participation' %}selected{% endif %}">Participation</a>
            <a href="/leaderboard/gc" class="btn btn-default gcommute {% if sort == 'gc' %}selected{% endif %}">Green commutes</a>
            <a href="/leaderboard/gs" class="btn btn-default gswitch {% if sort == 'gs' %}selected{% endif %}">Green switches</a>
            {% endif %}

            {% if filt and not empid %}
            <a href="/leaderboard/participation" class="btn btn-default participation {% if sort == 'participation' %}selected{% endif %}">Participation</a>
            <a href="/leaderboard/gc" class="btn btn-default gcommute {% if sort == 'gc' %}selected{% endif %}">Green commutes</a>
            <a href="/leaderboard/gs" class="btn btn-default gswitch {% if sort == 'gs' %}selected{% endif %}">Green switches</a>
            {% endif %}
            {% if empid %}
            <a href="/leaderboard/participation" class="btn btn-default participation {% if sort == 'participation' %}selected{% endif %}">Participation</a>
            <a href="/leaderboard/gc" class="btn btn-default gcommute {% if sort == 'gc' %}selected{% endif %}">Green commutes</a>
            <a href="/leaderboard/gs" class="btn btn-default gswitch {% if sort == 'gs' %}selected{% endif %}">Green switches</a>
            {% endif %}
            </div>
        </div> -->
		</form>
    </div>
    <div class="row clearfix">
        <div class="col-md-12 column">
            
        </div>
    </div>

    <div class="row clearfix">

        <div class="col-md-10 col-md-offset-1 column">
            <hr>
            <h1 class="leaderboard"><span class="
                {% if sort == 'participation' %}participation{% endif %}{% if sort == 'gc' %}gcommute{% endif %}{% if sort == 'gs' %}gswitch{% endif %}">{% if sort == 'participation' %}Participation{% endif %}{% if sort == 'gc' %}Green commutes{% endif %}{% if sort == 'gs' %}Green switches{% endif %}</span> {{ display_month }}</h1>  
            <h2 class="leaderboard" style="margin-top: -15px; margin-bottom:10px;">{% if filter_by == 'sector' %}{{ emp_sector }}{% endif %}{% if filter_by == 'size' %}{{ sizecat }}{% endif %} <br>
            {% if sort == 'participation' %}<span class="participation" style="font-family: aleolightitalic; font-size: 0.75em;">{{ total }} check ins across {{ total_companies }} organizations.</span>{% endif %}{% if sort == 'gc' %}<span class="gcommute" style="font-family: aleolightitalic; font-size: 0.75em;">{{ total }} green commutes across {{ total_companies }} organizations. Green commutes make use of walking, biking, running, taking transit, or using alternative driving arrangements such as carpooling or carsharing.</span>{% endif %}{% if sort == 'gs' %}<span class="gswitch" style="font-family: aleolightitalic; font-size: 0.75em;">{{ total }} green switches across {{ total_companies }} organizations. Green switches are made by commuters adding at least one new green mode of transportation to their commute.</span>{% endif %}</h2>
        </div>
    </div>

    <div class="row clearfix">
        <div class="col-md-5 col-md-offset-1 column">
			{% if sort == 'participation' %}
            <h3 class="ranktitle">Total check ins</h3>
			{% endif %}
			{% if sort == 'gc' %}
            <h3 class="ranktitle">Number of green commutes</h3>
			{% endif %}
			{% if sort == 'gs' %}
            <h3 class="ranktitle">Number of green switches</h3>
			{% endif %}

            <div class="list-group">
            <ol class="lbrank">
                {% for rank in ranks %} 
                {% if forloop.counter < 11 and rank.id != 1105 %}
                <li><a class="list-group-item company" href="/leaderboard/{{ rank.2 }}/#details">{{ rank.1 }}<span class="badge">{{ rank.0 }}</span></a></li> 
                {% endif %}
                {% endfor %}
            </ol>
            </div>

        </div>
        <div class="col-md-5 column">
			{% if sort == 'participation' %}
			<h3 class="ranktitle">Percentage checking in</h3>
			{% endif %}
			{% if sort == 'gc' %}
            <h3 class="ranktitle">Percentage of commutes that are green</h3>
			{% endif %}
			{% if sort == 'gs' %}
            <h3 class="ranktitle">Percentage of commutes that are green switches</h3>
			{% endif %}

            <div class="list-group">
            <ol class="lbrank">
                {% for rank in ranks_pct %} 
                {% if forloop.counter < 11 and rank.id != 1105 %}
                <li><a class="list-group-item company" href="/leaderboard/{{ rank.2 }}/#details">{{ rank.1 }}<span class="badge">{{ rank.0|floatformat }}</span></a></li> 
                {% endif %}
                {% endfor %}
            </ol>
            </div>

        </div>
    </div>

    <!-- carbon dioxide info -->

    <!-- calories info -->


{% if empid != 0 %}
    <div class="row clearfix">
        <div class="col-md-12 column">
            <a id="details"></a>
            <hr>
            <h1 class="leaderboard">{{ employer.name }}</h1>
        </div>
    </div>


    <div class="row clearfix">
        <div class="col-md-4 column summary participation">
            <h4>Employee Participation</h4>
            <p>{{ ncommutes }} commutes</p>
            <p>{{ participation|floatformat }}% of employees</p>
        </div>
        <div class="col-md-4 column summary gcommute">
            <h4>Green Commutes</h4>
            <p>{{ gc }} commutes</p>
            <p>{{ gc_pct|floatformat }}% of all checkins</p>
        </div>
        <div class="col-md-4 column summary gswitch">
            <h4>Green Switches</h4>
            <p>{{ gs }} switches</p>
            <p>{{ gs_pct|floatformat }}% of all checkins</p>
        </div>
       <!--  <div class="col-md-2 column summary co2">
            <h4>Carbon Dioxide</h4>
            <p>(Number) tons saved</p>
            <p>(Number unit) per employee</p>
        </div>
        <div class="col-md-2 column summary calories">
            <h4>Calories Burned</h4>
            <p>(Number) burned</p>
            <p>(Number unit) per employee</p>
        </div> -->

    </div>

    <div class="row clearfix">
        <div class="col-md-8 column"> 
            <!-- Where the generated bar chart goes -->
            <div id="breakDownGraph" style="height:300px"></div>
        </div>
        <div class="col-md-3 column"> 
            <div id="totalBreakDown">
            <table class="table table-borderless">
                <tr>
                    <th id="totals"><h4>Totals: </h4></th>
                </tr>

                <tr>
                    <td><div class="gc text-right">Commutes:</div></td>
                    <td class="gc" id="total_checkins">{{ ncommutes }}</td>
                </tr>
                <tr>
                    <td><div class="text-right">Green Switches:</div></td>
                    <td class="gstd" id="total_gs">{{ gs_total }}</td>
                </tr>
                <tr>
                    <td><div class="text-right">Green Commutes:</div></td>
                    <td class="gctd" id="total_gc">{{ gc_total }}</td>
                </tr>
                <tr>
                    <td><div class="text-right">Car Commutes:</div></td>
                    <td class="cctd" id="total_cc">{{ cc_total }}</td>
                </tr>
                <tr>
                    <td><div class="text-right">Other:</div></td>
                    <td class="ustd" id="total_us">{{ other_total }}</td>
                </tr>
            </table>
            </div>
        </div>
    </div>
    {% endif %}


{% endblock %}


